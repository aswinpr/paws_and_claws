{% load static %}
<!DOCTYPE html>
<html>
<head>
  <title>My Bookings</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .booking-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: #fafafa;
      position: relative;
    }
    .booking-header {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 8px;
    }
    .badge {
      background: #4CAF50;
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
    }
    .cancel-btn {
      background: #e53935;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<h1>üêæ My Bookings</h1>

{% if bookings %}
  {% for b in bookings %}
    <div class="booking-card" id="booking-{{ b.id }}">
      <div class="booking-header">
        {{ b.package_name }} 
        <span class="badge">{{ b.service_type }}</span>
      </div>

      <p><strong>Pet:</strong> {{ b.pet_name }} ({{ b.pet_type }})</p>
      <p><strong>Price:</strong> ‚Çπ{{ b.price }}</p>
      <p><strong>Date:</strong> {{ b.start_date }}</p>

      {% if b.time_slot %}
        <p><strong>Time:</strong> {{ b.time_slot }}</p>
      {% endif %}

      <p><strong>Booked On:</strong> {{ b.created_at }}</p>

      <!-- ‚úÖ Cancel Button -->
      <button class="cancel-btn"
        onclick="cancelBooking('{{ b.id }}')">
        Cancel Booking
      </button>
    </div>
  {% endfor %}
{% else %}
  <p>You have no bookings yet.</p>
{% endif %}

<script>
function getCSRFToken() {
  let cookieValue = null;
  const name = "csrftoken";
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === name + "=") {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function cancelBooking(bookingId) {
  if (!confirm("Are you sure you want to cancel this booking?")) {
    return;
  }

  fetch(`/services/cancel-booking/${bookingId}/`, {
    method: "POST",
    headers: {
      "X-CSRFToken": getCSRFToken()
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      // Remove card from UI
      const card = document.getElementById("booking-" + bookingId);
      if (card) card.remove();
      alert("Booking cancelled successfully.");
    } else {
      alert(data.message || "Failed to cancel booking.");
    }
  })
  .catch(err => {
    console.error(err);
    alert("Server error while cancelling.");
  });
}
</script>

</body>
</html>
